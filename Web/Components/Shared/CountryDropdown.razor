@using PetAdoption.Data.TableStorage.Validation
@using Microsoft.AspNetCore.Components.Forms
@using PetAdoption.Services.Web
@inject IConfiguration Configuration
@inject LocalizationService LocalizationService
@inject DynamicLocalizer<CountryDropdown> Localizer
@implements IDisposable

<div class="country-dropdown-wrapper">
    <select @ref="selectElement" 
            class="@CssClass" 
            value="@CurrentValue"
            @onchange="HandleChange"
            @onkeydown="HandleKeyDown"
            @attributes="AdditionalAttributes">
        @if (string.IsNullOrEmpty(CurrentValue))
        {
            <option value="">@Localizer["SelectCountry"]</option>
        }
        @foreach (var country in countries)
        {
            <option value="@country" selected="@(country == CurrentValue)">@country</option>
        }
    </select>
</div>

@code {
    private ElementReference selectElement;
    private List<string> countries = new();
    private string? currentValue;
    private string? lastKeyPressed;
    private DateTime lastKeyPressTime = DateTime.MinValue;
    private int currentMatchIndex = 0;

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    [Parameter]
    public string CssClass { get; set; } = "form-select";

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    protected string? CurrentValue
    {
        get => currentValue;
        set
        {
            if (currentValue == value) return;
            currentValue = value;
            _ = ValueChanged.InvokeAsync(value);
        }
    }

    protected override void OnInitialized()
    {
        countries = IcaoCountryLoader.GetCountryList();

        if (string.IsNullOrEmpty(Value))
        {
            var defaultCountry = Configuration["DefaultCountryValue"];
            if (!string.IsNullOrEmpty(defaultCountry) && countries.Contains(defaultCountry))
            {
                currentValue = defaultCountry;
                _ = ValueChanged.InvokeAsync(currentValue);
            }
        }
        else
        {
            currentValue = Value;
        }

        // Subscribe to culture change
        LocalizationService.OnCultureChanged += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LocalizationService.OnCultureChanged -= OnCultureChanged;
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(Value) && Value != currentValue)
        {
            currentValue = Value;
        }
        else if (string.IsNullOrEmpty(Value) && string.IsNullOrEmpty(currentValue))
        {
            var defaultCountry = Configuration["DefaultCountryValue"];
            if (!string.IsNullOrEmpty(defaultCountry) && countries.Contains(defaultCountry))
            {
                currentValue = defaultCountry;
                _ = ValueChanged.InvokeAsync(currentValue);
            }
        }
    }

    private void HandleChange(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        CurrentValue = newValue;
        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key.Length != 1 || !char.IsLetter(e.Key[0]))
            return;

        var key = e.Key.ToUpperInvariant();
        var now = DateTime.Now;

        if (key == lastKeyPressed && (now - lastKeyPressTime).TotalMilliseconds < 1000)
        {
            currentMatchIndex++;
        }
        else
        {
            currentMatchIndex = 0;
            lastKeyPressed = key;
        }

        lastKeyPressTime = now;

        var matches = countries
            .Where(c => c.StartsWith(key, StringComparison.OrdinalIgnoreCase))
            .ToList();

        if (matches.Any())
        {
            var selectedCountry = matches[currentMatchIndex % matches.Count];
            CurrentValue = selectedCountry;
            StateHasChanged();
        }

        await Task.Delay(10);
    }
}
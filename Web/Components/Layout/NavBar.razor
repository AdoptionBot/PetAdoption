@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using PetAdoption.Services
@using PetAdoption.Services.Interfaces
@using PetAdoption.Services.Web
@using PetAdoption.Web.Components.Shared
@implements IDisposable
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService
@inject NavigationManager Navigation
@inject ProfileStateService ProfileState
@inject LocalizationService LocalizationService
@inject DynamicLocalizer<NavBar> Localizer
@inject IConfiguration Configuration

<nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
    <div class="container position-relative">
        <a class="navbar-brand logo-brand" href="/" @onclick="HandleNavigation" @onclick:preventDefault="@(!isProfileComplete)">
            <img src="/images/CAM_Logo.png" alt="CAM Logo" class="navbar-logo" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="fas fa-bars"></span> Menu
        </button>
        <div class="collapse navbar-collapse" id="ftco-nav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <NavLink class="@($"nav-link {GetDisabledClass()}")" href="/pets" Match="NavLinkMatch.Prefix" @onclick="@((e) => HandleNavLinkClick(e, "/pets"))">@Localizer["Pets"]</NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="@($"nav-link {GetDisabledClass()}")" href="/shelters" Match="NavLinkMatch.Prefix" @onclick="@((e) => HandleNavLinkClick(e, "/shelters"))">@Localizer["Shelters"]</NavLink>
                </li>
                <AuthorizeView Roles="User,Foster,Shelter,Admin">
                    <Authorized>
                        <li class="nav-item">
                            <NavLink class="@($"nav-link {GetDisabledClass()}")" href="/adoptions" Match="NavLinkMatch.Prefix" @onclick="@((e) => HandleNavLinkClick(e, "/adoptions"))">@Localizer["Adoptions"]</NavLink>
                        </li>
                    </Authorized>
                </AuthorizeView>
                <li class="nav-item">
                    <NavLink class="@($"nav-link {GetDisabledClass()}")" href="/vet" Match="NavLinkMatch.Prefix" @onclick="@((e) => HandleNavLinkClick(e, "/vet"))">@Localizer["Vets"]</NavLink>
                </li>
                <li class="nav-item">
                    <NavLink class="@($"nav-link {GetDisabledClass()}")" href="/Testimonials" Match="NavLinkMatch.Prefix" @onclick="@((e) => HandleNavLinkClick(e, "/Testimonials"))">@Localizer["Testimonials"]</NavLink>
                </li>

                <AuthorizeView>
                    <Authorized>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/profile">
                                <span class="fas fa-user me-1"></span><span class="nav-text">@Localizer["Profile"]</span>
                            </NavLink>
                        </li>
                        <AuthorizeView Roles="Shelter,Admin" Context="shelterContext">
                            <Authorized>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle @GetDisabledClass()" href="#" id="shelterDropdown" role="button"
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                       @onclick:preventDefault="@(!isProfileComplete)">
                                        <span class="fas fa-home me-1"></span><span class="nav-text">@Localizer["Shelter"]</span>
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="shelterDropdown">
                                        <a class="dropdown-item @GetDisabledClass()" href="/shelter"
                                           @onclick='() => HandleNavigationClick("/shelter")' @onclick:preventDefault="true">
                                            <span class="fas fa-building me-1"></span> @Localizer["MyShelter"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/mypets"
                                           @onclick='() => HandleNavigationClick("/mypets")' @onclick:preventDefault="true">
                                            <span class="fas fa-paw me-1"></span> @Localizer["ManagePets"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/adoptionagreement"
                                           @onclick='() => HandleNavigationClick("/adoptionagreement")' @onclick:preventDefault="true">
                                            <span class="fas fa-file-contract me-1"></span> @Localizer["AdoptionAgreement"]
                                        </a>
                                    </div>
                                </li>
                            </Authorized>
                        </AuthorizeView>
                        <AuthorizeView Policy="AdminOnly" Context="adminContext">
                            <Authorized>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle @GetDisabledClass()" href="#" id="adminDropdown" role="button"
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                       @onclick:preventDefault="@(!isProfileComplete)">
                                        <span class="fas fa-cog me-1"></span><span class="nav-text">@Localizer["Admin"]</span>
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="adminDropdown">
                                        <a class="dropdown-item @GetDisabledClass()" href="/admin/users"
                                           @onclick='() => HandleNavigationClick("/admin/users")' @onclick:preventDefault="true">
                                            <span class="fas fa-users me-1"></span> @Localizer["ManageUsers"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/admin/shelters"
                                           @onclick='() => HandleNavigationClick("/admin/shelters")' @onclick:preventDefault="true">
                                            <span class="fas fa-home me-1"></span> @Localizer["ManageShelters"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/admin/veterinarians"
                                           @onclick='() => HandleNavigationClick("/admin/veterinarians")' @onclick:preventDefault="true">
                                            <span class="fas fa-hospital me-1"></span> @Localizer["ManageVeterinarians"]
                                        </a>
                                    </div>
                                </li>
                            </Authorized>
                        </AuthorizeView>
                        <li class="nav-item">
                            <a class="nav-link" href="/api/auth/logout">
                                <span class="fas fa-sign-out-alt me-1"></span><span class="nav-text">@Localizer["Logout"]</span>
                            </a>
                        </li>
                    </Authorized>
                    <NotAuthorized>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/login">
                                <span class="fas fa-sign-in-alt me-1"></span><span class="nav-text">@Localizer["Login"]</span>
                            </NavLink>
                        </li>
                    </NotAuthorized>
                </AuthorizeView>

                <!-- Language Switcher -->
                <li class="nav-item">
                    <LanguageSwitcher />
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Contact Bar - positioned below navbar -->
<div class="bottom-contact-bar">
    <div class="container">
        <div class="row">
            <div class="col-12 d-flex justify-content-end align-items-center">
                <p class="mb-0 contact-email me-4">
                    <a href="mailto:@organizationEmail?subject=Pet%20Adoption%20Inquiry">
                        <span class="fa fa-paper-plane me-2"></span> @organizationEmail
                    </a>
                </p>
                <div class="social-media-links">
                    <a href="@facebookUrl" target="_blank" rel="noopener noreferrer" title="Facebook">
                        <span class="fa-brands fa-facebook"></span>
                    </a>
                    <a href="@xUrl" target="_blank" rel="noopener noreferrer" title="X (Twitter)">
                        <span class="fa-brands fa-x-twitter"></span>
                    </a>
                    <a href="@instagramUrl" target="_blank" rel="noopener noreferrer" title="Instagram">
                        <span class="fa-brands fa-instagram"></span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Increased height navbar */
    .ftco_navbar {
        padding-top: 0.75rem !important;
        padding-bottom: 0.75rem !important;
        min-height: 65px !important;
        position: relative;
        overflow: visible !important;
        z-index: 1030;
    }

    .ftco_navbar .container {
        padding-left: 140px;
        position: relative;
        overflow: visible !important;
    }

    /* Tighter navbar nav items with increased padding */
    .ftco_navbar .navbar-nav {
        margin-top: 0;
        margin-bottom: 0;
    }

    .ftco_navbar .nav-item {
        padding-top: 0;
        padding-bottom: 0;
    }

    .ftco_navbar .nav-link {
        padding-top: 0.875rem !important;
        padding-bottom: 0.875rem !important;
        font-size: 0.95rem;
    }

    /* Logo positioning - UNCHANGED */
    .logo-brand {
        padding: 0 !important;
        margin-right: 0;
        position: absolute;
        left: 15px;
        top: -10px;
        z-index: 1050;
        line-height: 0;
    }

    /* Logo styling - UNCHANGED */
    .navbar-logo {
        height: 120px;
        width: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: transparent;
        display: block;
    }

    .navbar-logo:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    /* Navbar navigation items */
    .navbar-collapse {
        margin-left: 0;
    }

    /* Contact Bar - FURTHER REDUCED HEIGHT with teal gradient */
    .bottom-contact-bar {
        background: linear-gradient(90deg, #0891b2 0%, #06b6d4 50%, #10b981 100%);
        padding: 4px 0;
        position: relative;
        z-index: 1000;
    }

    .bottom-contact-bar .container {
        padding-right: 15px;
        padding-left: 15px;
    }

    .bottom-contact-bar .contact-email a {
        color: #fff;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 400;
        transition: opacity 0.3s ease;
        line-height: 1;
    }

    .bottom-contact-bar .contact-email a:hover {
        opacity: 0.85;
    }

    .bottom-contact-bar .social-media-links {
        display: flex;
        gap: 14px;
        align-items: center;
    }

    .bottom-contact-bar .social-media-links a {
        color: #fff;
        font-size: 1rem;
        transition: transform 0.3s ease, opacity 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }

    .bottom-contact-bar .social-media-links a:hover {
        transform: scale(1.15);
        opacity: 0.85;
    }

    /* Active state for nav links - keep green text and underline */
    .ftco_navbar .nav-link.active {
        color: #00bd56 !important;
    }

    .ftco_navbar .nav-link.active:before {
        content: "";
        position: absolute;
        width: 100%;
        height: 2px;
        bottom: 0px;
        left: 0;
        background-color: #00bd56;
        visibility: visible;
        -webkit-transform: scaleX(1);
        -ms-transform: scaleX(1);
        transform: scaleX(1);
        z-index: -1;
    }

    /* Ensure disabled links don't show active styling */
    .ftco_navbar .nav-link.disabled {
        color: #6c757d !important;
    }

    .ftco_navbar .nav-link.disabled:before {
        visibility: hidden !important;
    }

    /* Mobile responsiveness */
    @@media (max-width: 991px) {
        .bottom-contact-bar {
            padding: 3px 0;
        }

        .bottom-contact-bar .contact-email a {
            font-size: 0.8rem;
        }

        .bottom-contact-bar .social-media-links {
            gap: 12px;
        }

        .bottom-contact-bar .social-media-links a {
            font-size: 0.95rem;
        }

        .ftco_navbar {
            min-height: 55px !important;
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }

        .navbar-logo {
            height: 85px;
            width: 85px;
            border-width: 1px;
            background-color: transparent;
        }

        .logo-brand {
            left: 10px;
            top: -20px;
        }

        .ftco_navbar .container {
            padding-left: 100px;
        }

        .ftco_navbar .nav-link {
            font-size: 0.9rem;
            padding-top: 0.6rem !important;
            padding-bottom: 0.6rem !important;
        }

        .ftco_navbar .nav-link.active:before {
            display: none;
        }
    }

    @@media (max-width: 576px) {
        .bottom-contact-bar {
            padding: 2px 0;
        }

        .bottom-contact-bar .contact-email {
            margin-right: 0.5rem !important;
        }

        .bottom-contact-bar .contact-email a {
            font-size: 0.7rem;
        }

        .bottom-contact_bar .social-media-links {
            gap: 8px;
        }

        .bottom-contact-bar .social-media-links a {
            font-size: 0.9rem;
        }

        .ftco_navbar {
            min-height: 48px !important;
            padding-top: 0.3rem !important;
            padding-bottom: 0.3rem !important;
        }

        .navbar-logo {
            height: 65px;
            width: 65px;
            border-width: 1px;
            background-color: transparent;
        }

        .logo-brand {
            top: -15px;
        }

        .ftco_navbar .container {
            padding-left: 80px;
        }

        .ftco_navbar .nav-link {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
            font-size: 0.85rem;
        }
    }
</style>

@code {
    private bool isProfileComplete = true;
    private string? userEmail;
    private string organizationEmail = string.Empty;
    private string facebookUrl = string.Empty;
    private string xUrl = string.Empty;
    private string instagramUrl = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Load configuration values
        organizationEmail = Configuration["OrganizationEmail"] ?? String.Empty;
        facebookUrl = Configuration["FacebookUrl"] ?? String.Empty;
        xUrl = Configuration["XUrl"] ?? String.Empty;
        instagramUrl = Configuration["InstagramUrl"] ?? String.Empty;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
            if (!string.IsNullOrEmpty(userEmail))
            {
                var currentUser = await UserService.GetUserByEmailAsync(userEmail);
                if (currentUser != null)
                {
                    isProfileComplete = currentUser.IsProfileCompleted;
                }
            }
        }

        // Subscribe to profile completion event
        ProfileState.OnProfileCompleted += HandleProfileCompleted;

        // Subscribe to culture change
        LocalizationService.OnCultureChanged += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleProfileCompleted()
    {
        isProfileComplete = true;
        InvokeAsync(StateHasChanged);
    }

    private void HandleNavLinkClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, string path)
    {
        if (!isProfileComplete)
        {
            // Prevent navigation if profile is incomplete
            var currentPath = new Uri(Navigation.Uri).AbsolutePath;
            if (!currentPath.Contains("/profile"))
            {
                Navigation.NavigateTo("/profile", forceLoad: true);
            }
        }
        // If profile is complete, NavLink will handle navigation automatically
    }

    private void HandleNavigationClick(string path)
    {
        if (isProfileComplete)
        {
            Navigation.NavigateTo(path);
        }
        else
        {
            var currentPath = new Uri(Navigation.Uri).AbsolutePath;
            if (!currentPath.Contains("/profile"))
            {
                Navigation.NavigateTo("/profile");
            }
        }
    }

    private void HandleNavigation(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        HandleNavigationClick("/");
    }

    private string GetDisabledClass()
    {
        return !isProfileComplete ? "disabled text-muted" : "";
    }

    public void Dispose()
    {
        ProfileState.OnProfileCompleted -= HandleProfileCompleted;
        LocalizationService.OnCultureChanged -= OnCultureChanged;
    }
}
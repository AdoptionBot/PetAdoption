@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using PetAdoption.Services
@using PetAdoption.Services.Interfaces
@using PetAdoption.Services.Web
@using PetAdoption.Web.Components.Shared
@implements IDisposable
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IUserService UserService
@inject NavigationManager Navigation
@inject ProfileStateService ProfileState
@inject LocalizationService LocalizationService
@inject DynamicLocalizer<NavBar> Localizer

<nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
    <div class="container position-relative">
        <a class="navbar-brand logo-brand" href="/" @onclick="HandleNavigation" @onclick:preventDefault="@(!isProfileComplete)">
            <img src="/images/CAM_Logo.png" alt="CAM Logo" class="navbar-logo" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="fas fa-bars"></span> Menu
        </button>
        <div class="collapse navbar-collapse" id="ftco-nav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link @GetDisabledClass()" href="/pets" @onclick='() => HandleNavigationClick("/pets")' @onclick:preventDefault="true">@Localizer["Pets"]</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @GetDisabledClass()" href="/shelters" @onclick='() => HandleNavigationClick("/shelters")' @onclick:preventDefault="true">@Localizer["Shelters"]</a>
                </li>
                <AuthorizeView Roles="User,Foster,Shelter,Admin">
                    <Authorized>
                        <li class="nav-item">
                            <a class="nav-link @GetDisabledClass()" href="/adoptions" @onclick='() => HandleNavigationClick("/adoptions")' @onclick:preventDefault="true">@Localizer["Adoptions"]</a>
                        </li>
                    </Authorized>
                </AuthorizeView>
                <li class="nav-item">
                    <a class="nav-link @GetDisabledClass()" href="/vet" @onclick='() => HandleNavigationClick("/vet")' @onclick:preventDefault="true">@Localizer["Vets"]</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @GetDisabledClass()" href="/Testimonials" @onclick='() => HandleNavigationClick("/Testimonials")' @onclick:preventDefault="true">@Localizer["Testimonials"]</a>
                </li>

                <AuthorizeView>
                    <Authorized>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/profile">
                                <span class="fas fa-user me-1"></span><span class="nav-text">@Localizer["Profile"]</span>
                            </NavLink>
                        </li>
                        <AuthorizeView Roles="Shelter,Admin" Context="shelterContext">
                            <Authorized>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle @GetDisabledClass()" href="#" id="shelterDropdown" role="button" 
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" 
                                       @onclick:preventDefault="@(!isProfileComplete)">
                                        <span class="fas fa-home me-1"></span><span class="nav-text">@Localizer["Shelter"]</span>
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="shelterDropdown">
                                        <a class="dropdown-item @GetDisabledClass()" href="/shelter" 
                                           @onclick='() => HandleNavigationClick("/shelter")' @onclick:preventDefault="true">
                                            <span class="fas fa-building me-1"></span> @Localizer["MyShelter"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/mypets" 
                                           @onclick='() => HandleNavigationClick("/mypets")' @onclick:preventDefault="true">
                                            <span class="fas fa-paw me-1"></span> @Localizer["ManagePets"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/adoptionagreement" 
                                           @onclick='() => HandleNavigationClick("/adoptionagreement")' @onclick:preventDefault="true">
                                            <span class="fas fa-file-contract me-1"></span> @Localizer["AdoptionAgreement"]
                                        </a>
                                    </div>
                                </li>
                            </Authorized>
                        </AuthorizeView>
                        <AuthorizeView Policy="AdminOnly" Context="adminContext">
                            <Authorized>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle @GetDisabledClass()" href="#" id="adminDropdown" role="button" 
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" 
                                       @onclick:preventDefault="@(!isProfileComplete)">
                                        <span class="fas fa-cog me-1"></span><span class="nav-text">@Localizer["Admin"]</span>
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="adminDropdown">
                                        <a class="dropdown-item @GetDisabledClass()" href="/admin/users" 
                                           @onclick='() => HandleNavigationClick("/admin/users")' @onclick:preventDefault="true">
                                            <span class="fas fa-users me-1"></span> @Localizer["ManageUsers"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/admin/shelters" 
                                           @onclick='() => HandleNavigationClick("/admin/shelters")' @onclick:preventDefault="true">
                                            <span class="fas fa-home me-1"></span> @Localizer["ManageShelters"]
                                        </a>
                                        <a class="dropdown-item @GetDisabledClass()" href="/admin/veterinarians" 
                                           @onclick='() => HandleNavigationClick("/admin/veterinarians")' @onclick:preventDefault="true">
                                            <span class="fas fa-hospital me-1"></span> @Localizer["ManageVeterinarians"]
                                        </a>
                                    </div>
                                </li>
                            </Authorized>
                        </AuthorizeView>
                        <li class="nav-item">
                            <a class="nav-link" href="/api/auth/logout">
                                <span class="fas fa-sign-out-alt me-1"></span><span class="nav-text">@Localizer["Logout"]</span>
                            </a>
                        </li>
                    </Authorized>
                    <NotAuthorized>
                        <li class="nav-item ml-auto">
                            <NavLink class="nav-link btn btn-primary text-white px-3 py-2 ml-2" href="/login">
                                <span class="fas fa-sign-in-alt me-1"></span><span class="nav-text">@Localizer["Login"]</span>
                            </NavLink>
                        </li>
                    </NotAuthorized>
                </AuthorizeView>
                
                <!-- Language Switcher -->
                <li class="nav-item">
                    <LanguageSwitcher />
                </li>
            </ul>
        </div>
    </div>
</nav>

<style>
    /* Compact navbar - MAIN FIX HERE */
    .ftco_navbar {
        padding-top: 0.15rem !important;  /* Drastically reduced */
        padding-bottom: 0.15rem !important; /* Drastically reduced */
        min-height: 50px !important; /* Reduced from 60px */
        position: relative;
        overflow: visible !important;
        z-index: 1030;
    }

        .ftco_navbar .container {
            padding-left: 140px; /* Slightly reduced from 160px */
            position: relative;
            overflow: visible !important;
        }

    /* Tighter navbar nav items */
    .ftco_navbar .navbar-nav {
        margin-top: 0;
        margin-bottom: 0;
    }

    .ftco_navbar .nav-item {
        padding-top: 0;
        padding-bottom: 0;
    }

    .ftco_navbar .nav-link {
        padding-top: 0.5rem !important; /* Reduced from default */
        padding-bottom: 0.5rem !important;
        font-size: 0.95rem; /* Slightly smaller text */
    }

    /* Logo positioning - overlaps contact bar */
    .logo-brand {
        padding: 0 !important;
        margin-right: 0;
        position: absolute;
        left: 15px;
        top: -45px; /* Fine-tuned from -50px */
        z-index: 1050;
        line-height: 0;
    }

    /* Slightly smaller logo for better proportions */
    .navbar-logo {
        height: 120px; /* Reduced from 130px */
        width: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: #fff;
        display: block;
    }

        .navbar-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

    /* Navbar navigation items */
    .navbar-collapse {
        margin-left: 0;
    }

    /* Mobile responsiveness */
    @@media (max-width: 991px) {
        .ftco_navbar {
            min-height: 45px !important;
            padding-top: 0.15rem !important;
            padding-bottom: 0.15rem !important;
        }

        .navbar-logo {
            height: 85px;
            width: 85px;
            border-width: 3px;
        }

        .logo-brand {
            left: 10px;
            top: -32px;
        }

        .ftco_navbar .container {
            padding-left: 100px;
        }

        .ftco_navbar .nav-link {
            font-size: 0.9rem;
        }
    }

    @@media (max-width: 576px) {
        .ftco_navbar {
            min-height: 42px !important;
            padding-top: 0.1rem !important;
            padding-bottom: 0.1rem !important;
        }

        .navbar-logo {
            height: 65px;
            width: 65px;
            border-width: 3px;
        }

        .logo-brand {
            top: -22px;
        }

        .ftco_navbar .container {
            padding-left: 80px;
        }

        .ftco_navbar .nav-link {
            padding-top: 0.4rem !important;
            padding-bottom: 0.4rem !important;
            font-size: 0.85rem;
        }
    }
</style>

@code {
    private bool isProfileComplete = true;
    private string? userEmail;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userEmail = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
            if (!string.IsNullOrEmpty(userEmail))
            {
                var currentUser = await UserService.GetUserByEmailAsync(userEmail);
                if (currentUser != null)
                {
                    isProfileComplete = currentUser.IsProfileCompleted;
                }
            }
        }

        // Subscribe to profile completion event
        ProfileState.OnProfileCompleted += HandleProfileCompleted;
        
        // Subscribe to culture change
        LocalizationService.OnCultureChanged += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleProfileCompleted()
    {
        isProfileComplete = true;
        InvokeAsync(StateHasChanged);
    }

    private void HandleNavigationClick(string path)
    {
        if (isProfileComplete)
        {
            Navigation.NavigateTo(path);
        }
        else
        {
            var currentPath = new Uri(Navigation.Uri).AbsolutePath;
            if (!currentPath.Contains("/profile"))
            {
                Navigation.NavigateTo("/profile");
            }
        }
    }

    private void HandleNavigation(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        HandleNavigationClick("/");
    }

    private string GetDisabledClass()
    {
        return !isProfileComplete ? "disabled text-muted" : "";
    }

    public void Dispose()
    {
        ProfileState.OnProfileCompleted -= HandleProfileCompleted;
        LocalizationService.OnCultureChanged -= OnCultureChanged;
    }
}

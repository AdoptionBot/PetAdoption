@page "/adoptionrequest"
@using Microsoft.AspNetCore.Authorization
@using PetAdoption.Services.Interfaces
@using PetAdoption.Data.TableStorage
@using PetAdoption.Data.TableStorage.Enums
@using PetAdoption.Services.Web
@attribute [Authorize(Roles = "User")]
@inject IPetService PetService
@inject IShelterService ShelterService
@inject IAdoptionProcessService AdoptionProcessService
@inject IUserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<AdoptionRequest> Logger
@inject LocalizationService LocalizationService
@inject DynamicLocalizer<AdoptionRequest> Localizer
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="fas fa-file-contract me-2"></i>@Localizer["AdoptionAgreement"]</h3>
                </div>
                <div class="card-body p-4">
                    @if (isLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">@Localizer["Loading"]</span>
                            </div>
                            <p class="mt-3">@Localizer["LoadingAgreement"]</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>@Localizer["Error"]</strong> @errorMessage
                        </div>
                        <div class="text-center">
                            <a href="/pets" class="btn btn-primary">
                                <i class="fas fa-arrow-left me-2"></i>@Localizer["BackToPets"]
                            </a>
                        </div>
                    }
                    else if (selectedPet != null && shelter != null)
                    {
                        <!-- Pet Information -->
                        <div class="alert alert-info mb-4">
                            <h5 class="mb-3">
                                <i class="fas fa-paw me-2"></i>@Localizer["YoureRequestingToAdopt"] <strong>@selectedPet.PartitionKey</strong>
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    @if (!string.IsNullOrEmpty(selectedPet.Image1Url))
                                    {
                                        <img src="@selectedPet.Image1Url" 
                                             class="img-fluid rounded mb-3" 
                                             alt="@selectedPet.PartitionKey"
                                             style="max-height: 200px; width: 100%; object-fit: cover;"
                                             onerror="this.src='/images/placeholder-pet.jpg';" />
                                    }
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>@Localizer["Species"]</strong> @selectedPet.Species</p>
                                    <p class="mb-1"><strong>@Localizer["Age"]</strong> @GetPetAge(selectedPet.RowKey)</p>
                                    <p class="mb-1"><strong>@Localizer["Gender"]</strong> @selectedPet.Gender</p>
                                    <p class="mb-0"><strong>@Localizer["Size"]</strong> @selectedPet.Size</p>
                                </div>
                            </div>
                        </div>

                        <!-- Shelter Information -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-home me-2"></i>@Localizer["ShelterInformation"]
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>@Localizer["ShelterName"]</strong> @shelter.PartitionKey</p>
                                    <p class="mb-1"><strong>@Localizer["Location"]</strong> @shelter.RowKey, @shelter.Country</p>
                                    <p class="mb-1"><strong>@Localizer["Phone"]</strong> @shelter.PhoneNumber</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>@Localizer["Email"]</strong> @shelter.Email</p>
                                    <p class="mb-0"><strong>@Localizer["Address"]</strong> @shelter.Address</p>
                                </div>
                            </div>
                        </div>

                        <!-- Adoption Agreement Rules -->
                        @if (!string.IsNullOrEmpty(shelter.AdoptionAgreementRules))
                        {
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-clipboard-list me-2"></i>@Localizer["AdoptionAgreementRules"]
                                </h5>
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div style="white-space: pre-wrap;">@shelter.AdoptionAgreementRules</div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Supporting Documents -->
                        @if (HasAnyDocuments())
                        {
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-file-pdf me-2"></i>@Localizer["SupportingDocuments"]
                                </h5>
                                <p class="text-muted small mb-3">
                                    @Localizer["SupportingDocumentsDesc"]
                                </p>

                                <div class="list-group">
                                    @if (!string.IsNullOrEmpty(shelter.Document1Url) && !string.IsNullOrEmpty(shelter.Document1Name))
                                    {
                                        <a href="@shelter.Document1Url" target="_blank" class="list-group-item list-group-item-action adoption-document-link">
                                            <i class="fas fa-file-alt me-2"></i>@shelter.Document1Name<span class="fas fa-share-square ms-2 text-muted small"></span>
                                        </a>
                                    }
                                    @if (!string.IsNullOrEmpty(shelter.Document2Url) && !string.IsNullOrEmpty(shelter.Document2Name))
                                    {
                                        <a href="@shelter.Document2Url" target="_blank" class="list-group-item list-group-item-action adoption-document-link">
                                            <i class="fas fa-file-alt me-2"></i>@shelter.Document2Name<span class="fas fa-share-square ms-2 text-muted small"></span>
                                        </a>
                                    }
                                    @if (!string.IsNullOrEmpty(shelter.Document3Url) && !string.IsNullOrEmpty(shelter.Document3Name))
                                    {
                                        <a href="@shelter.Document3Url" target="_blank" class="list-group-item list-group-item-action adoption-document-link">
                                            <i class="fas fa-file-alt me-2"></i>@shelter.Document3Name<span class="fas fa-share-square ms-2 text-muted small"></span>
                                        </a>
                                    }
                                    @if (!string.IsNullOrEmpty(shelter.Document4Url) && !string.IsNullOrEmpty(shelter.Document4Name))
                                    {
                                        <a href="@shelter.Document4Url" target="_blank" class="list-group-item list-group-item-action adoption-document-link">
                                            <i class="fas fa-file-alt me-2"></i>@shelter.Document4Name<span class="fas fa-share-square ms-2 text-muted small"></span>
                                        </a>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Additional Notes Display -->
                        @if (!string.IsNullOrEmpty(adoptionNotes))
                        {
                            <div class="mb-4">
                                <h5 class="border-bottom pb-2">
                                    <i class="fas fa-comment me-2"></i>@Localizer["YourNotes"]
                                </h5>
                                <div class="alert alert-light">
                                    <p class="mb-0">@adoptionNotes</p>
                                </div>
                            </div>
                        }

                        <!-- Agreement Acceptance Checkbox -->
                        <div class="mb-4 p-4 bg-light rounded border">
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="agreementCheck" 
                                       @bind="hasAcceptedAgreement"
                                       disabled="@isSubmitting" />
                                <label class="form-check-label fw-bold" for="agreementCheck">
                                    <i class="fas fa-check-circle me-2 @(hasAcceptedAgreement ? "text-success" : "text-muted")"></i>
                                    @Localizer["AgreeToTerms"]
                                </label>
                            </div>
                            @if (!hasAcceptedAgreement)
                            {
                                <p class="small text-muted mt-2 mb-0">
                                    <i class="fas fa-info-circle me-1"></i>
                                    @Localizer["MustAcceptAgreement"]
                                </p>
                            }
                        </div>

                        <!-- Submit Section -->
                        @if (isSubmitting)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">@Localizer["Submitting"]</span>
                                </div>
                                <p class="mt-3">@Localizer["SubmittingRequest"]</p>
                            </div>
                        }
                        else
                        {
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-secondary btn-lg w-100" @onclick="Cancel">
                                        <i class="fas fa-times me-2"></i>@Localizer["Cancel"]
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" 
                                            class="btn btn-success btn-lg w-100" 
                                            @onclick="SubmitAdoptionRequest"
                                            disabled="@(!hasAcceptedAgreement)">
                                        <i class="fas fa-heart me-2"></i>@Localizer["RequestAdoptionFor", selectedPet.PartitionKey]
                                    </button>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
@if (showSuccessModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-success border-3">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>@Localizer["AdoptionRequestSubmitted"]
                    </h5>
                </div>
                <div class="modal-body text-center py-5">
                    <i class="fas fa-heart fa-5x text-danger mb-4 adoption-animated-heartbeat"></i>
                    <h3 class="mb-3">@Localizer["Congratulations"]</h3>
                    <p class="lead mb-4">
                        @Localizer["RequestSubmittedSuccess", selectedPet?.PartitionKey ?? string.Empty, shelter?.PartitionKey ?? string.Empty]
                    </p>
                    <div class="alert alert-info">
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            @Localizer["ShelterWillReview"]
                        </p>
                    </div>
                    <p class="text-muted small mt-3">
                        <i class="fas fa-paw me-1"></i>
                        @Localizer["ThankYouForAdopting", selectedPet?.PartitionKey ?? string.Empty]
                    </p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg px-5" @onclick="GoToAdoptionsPage">
                        <i class="fas fa-check me-2"></i>@Localizer["OK"]
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery(Name = "pet")]
    public string? PetName { get; set; }

    [SupplyParameterFromQuery(Name = "birthdate")]
    public string? PetBirthDate { get; set; }

    [SupplyParameterFromQuery(Name = "notes")]
    public string? AdoptionNotesParam { get; set; }

    private Pet? selectedPet;
    private Shelter? shelter;
    private User? currentUser;
    private string adoptionNotes = string.Empty;
    private bool hasAcceptedAgreement = false;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool showSuccessModal = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var email = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
                if (!string.IsNullOrEmpty(email))
                {
                    currentUser = await UserService.GetUserByEmailAsync(email);
                }
            }

            if (currentUser == null)
            {
                errorMessage = "User not found. Please log in.";
                return;
            }

            // Validate parameters
            if (string.IsNullOrEmpty(PetName) || string.IsNullOrEmpty(PetBirthDate))
            {
                errorMessage = "Invalid pet information. Please select a pet from the pets page.";
                return;
            }

            // Load pet
            selectedPet = await PetService.GetPetAsync(PetName, PetBirthDate);
            if (selectedPet == null)
            {
                errorMessage = "Pet not found. The pet may have been adopted or removed.";
                return;
            }

            // Load shelter
            shelter = await ShelterService.GetShelterAsync(selectedPet.ShelterName, selectedPet.ShelterLocation);
            if (shelter == null)
            {
                errorMessage = "Shelter information not found. Please contact support.";
                return;
            }

            // Get notes from parameter
            if (!string.IsNullOrEmpty(AdoptionNotesParam))
            {
                adoptionNotes = Uri.UnescapeDataString(AdoptionNotesParam);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading adoption request page");
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }

        // Subscribe to culture change
        LocalizationService.OnCultureChanged += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        LocalizationService.OnCultureChanged -= OnCultureChanged;
    }

    private bool HasAnyDocuments()
    {
        if (shelter == null) return false;

        return (!string.IsNullOrEmpty(shelter.Document1Url) && !string.IsNullOrEmpty(shelter.Document1Name)) ||
               (!string.IsNullOrEmpty(shelter.Document2Url) && !string.IsNullOrEmpty(shelter.Document2Name)) ||
               (!string.IsNullOrEmpty(shelter.Document3Url) && !string.IsNullOrEmpty(shelter.Document3Name)) ||
               (!string.IsNullOrEmpty(shelter.Document4Url) && !string.IsNullOrEmpty(shelter.Document4Name));
    }

    private string GetPetAge(string birthDateString)
    {
        if (!DateTime.TryParse(birthDateString, out var birthDate))
            return "Unknown";

        var age = DateTime.Now - birthDate;
        var years = (int)(age.TotalDays / 365.25);
        var months = (int)((age.TotalDays % 365.25) / 30.44);

        if (years > 0)
        {
            return months > 0 ? $"{years} year{(years > 1 ? "s" : "")} {months} month{(months > 1 ? "s" : "")}" 
                              : $"{years} year{(years > 1 ? "s" : "")}";
        }
        else if (months > 0)
        {
            return $"{months} month{(months > 1 ? "s" : "")}";
        }
        else
        {
            var days = (int)age.TotalDays;
            return $"{days} day{(days > 1 ? "s" : "")}";
        }
    }

    private async Task SubmitAdoptionRequest()
    {
        if (!hasAcceptedAgreement || selectedPet == null || currentUser == null)
            return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var result = await AdoptionProcessService.SubmitAdoptionApplicationAsync(
                currentUser.PartitionKey,
                currentUser.RowKey,
                selectedPet.PartitionKey,
                selectedPet.RowKey,
                adoptionNotes);

            if (result.Success)
            {
                Logger.LogInformation(
                    "Adoption request submitted successfully for pet {PetName} by user {UserName}",
                    selectedPet.PartitionKey,
                    currentUser.PartitionKey);

                showSuccessModal = true;
            }
            else
            {
                errorMessage = result.Message;
                await JSRuntime.InvokeVoidAsync("window.scrollTo", new { top = 0, behavior = "smooth" });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error submitting adoption request");
            errorMessage = "An unexpected error occurred. Please try again.";
            await JSRuntime.InvokeVoidAsync("window.scrollTo", new { top = 0, behavior = "smooth" });
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/pets");
    }

    private void GoToAdoptionsPage()
    {
        Navigation.NavigateTo("/adoptions");
    }
}
@page "/adoptions"
@using Microsoft.AspNetCore.Authorization
@using PetAdoption.Data.TableStorage
@using PetAdoption.Data.TableStorage.Enums
@using PetAdoption.Services.Interfaces
@using PetAdoption.Services.Web
@using PetAdoption.Web.Components.Shared
tAdoption.Web.Components.Shared
@attribute [Authorize(Roles = "User,Foster,Shelter,Admin")]
@inject IAdoptionProcessService AdoptionProcessService
@inject IUserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ILogger<Adoptions> Logger
@inject LocalizationService LocalizationService
@inject DynamicLocalizer<Adoptions> Localizer
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<div class="adoptions-page-wrapper">
    <section class="hero-wrap hero-wrap-2" style="background-image: url('images/bg_2.jpg');" data-stellar-background-ratio="0.5">
        <div class="overlay"></div>
        <div class="container">
            <div class="row no-gutters slider-text align-items-end">
                <div class="col-md-9 ftco-animate pb-5">
                    <p class="breadcrumbs mb-2">
                        <span class="mr-2"><a href="/">@Localizer["Home"] <i class="ion-ios-arrow-forward"></i></a></span>
                        <span>@Localizer["Adoptions"] <i class="ion-ios-arrow-forward"></i></span>
                    </p>
                    <h1 class="mb-0 bread">@pageTitle</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="ftco-section">
        <div class="container">
            @if (isLoading)
            {
                <div class="row">
                    <div class="col-md-12 text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">@Localizer["LoadingApplications"]</span>
                        </div>
                        <p class="mt-3">@Localizer["LoadingApplications"]</p>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-danger">
                            <h4>@Localizer["ErrorLoadingTitle"]</h4>
                            <p>@errorMessage</p>
                            <button class="btn btn-primary" @onclick="LoadApplicationsAsync">
                                <i class="fa fa-refresh"></i> @Localizer["Retry"]
                            </button>
                        </div>
                    </div>
                </div>
            }
            else if (!applications.Any())
            {
                <div class="row">
                    <div class="col-md-12 text-center">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle fa-3x mb-3"></i>
                            <h3>@Localizer["NoAdoptionApplications"]</h3>
                            <p>@(isUserRole ? Localizer["NoApplicationsMessageUser"] : Localizer["NoApplicationsMessageShelter"])</p>
                            @if (isUserRole)
                            {
                                <a href="/pets" class="btn btn-primary mt-2">
                                    <i class="fa fa-paw"></i> @Localizer["BrowseAvailablePets"]
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show">
                        <i class="fa fa-check-circle"></i> @successMessage
                        <button type="button" class="btn-close" @onclick="() => successMessage = null" aria-label="Close"></button>
                    </div>
                }

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fa fa-list"></i>
                                    @(isUserRole ? Localizer["YourAdoptionApplications"] : Localizer["AdoptionApplicationsForYourPets"])
                                </h5>
                                <p class="text-muted mb-0">
                                    @Localizer["TotalApplications"]: <strong>@applications.Count</strong>
                                    @if (applications.Count(a => a.AdoptionStatus == AdoptionStatus.Adopted) > 0)
                                    {
                                        <span class="ms-3">
                                            <i class="fa fa-heart text-danger"></i>
                                            @Localizer["SuccessfullyAdopted"]: <strong class="text-success">@applications.Count(a => a.AdoptionStatus == AdoptionStatus.Adopted)</strong>
                                        </span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    @foreach (var application in applications)
                    {
                        var pet = applicationPets.ContainsKey(application) ? applicationPets[application] : null;
                        var applicantUser = applicationUsers.ContainsKey(application) ? applicationUsers[application] : null;
                        var isAdopted = application.AdoptionStatus == AdoptionStatus.Adopted;

                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm application-card @(isAdopted ? "adopted-card" : "")">
                                @if (isAdopted)
                                {
                                    <div class="adoption-celebration-ribbon">
                                        <i class="fa fa-heart"></i> @Localizer["Adopted"].ToUpperInvariant()<i class="fa fa-heart"></i>
                                    </div>
                                }
                                <div class="card-header bg-@GetStatusColor(application.AdoptionStatus) text-white">
                                    <h6 class="mb-0">
                                        <i class="fa fa-paw"></i> @application.PetName
                                        @if (isAdopted)
                                        {
                                            <span class="float-end">
                                                <i class="fa fa-star animated-star"></i>
                                            </span>
                                        }
                                    </h6>
                                </div>
                                <div class="card-body @(isAdopted ? "adopted-body" : "")">
                                    @if (isAdopted && isUserRole)
                                    {
                                        <div class="congratulations-banner mb-3">
                                            <div class="text-center py-3">
                                                <i class="fa fa-trophy text-warning fa-2x mb-2 animated-bounce"></i>
                                                <h6 class="text-success fw-bold mb-1">🎉 @Localizer["Congratulations"]! 🎉</h6>
                                                <p class="small text-muted mb-0">@Localizer["NowLovingPetParent"]</p>
                                            </div>
                                        </div>
                                    }

                                    @if (pet != null)
                                    {
                                        <div class="position-relative">
                                            @if (!string.IsNullOrEmpty(pet.Image1Url))
                                            {
                                                <img src="@pet.Image1Url"
                                                     class="card-img-top mb-3 rounded adoption-pet-image clickable-image-card @(isAdopted ? "adopted-image" : "")"
                                                     alt="@pet.PartitionKey"
                                                     style="cursor: pointer;"
                                                     @onclick="() => ShowImageViewer(pet.Image1Url)"
                                                     @onclick:stopPropagation="true"
                                                     onerror="this.src='/images/placeholder-pet.jpg';" />
                                                @if (isAdopted)
                                                {
                                                    <div class="heart-overlay" style="pointer-events: none;">
                                                        <i class="fa fa-heart fa-3x text-danger animated-heartbeat"></i>
                                                    </div>
                                                }
                                            }
                                        </div>
                                        <p class="mb-1"><strong>@Localizer["Species"]:</strong> @pet.Species</p>
                                        <p class="mb-1"><strong>@Localizer["Age"]:</strong> @GetPetAge(pet.RowKey)</p>
                                        <p class="mb-1">
                                            <strong>@Localizer["Shelter"]:</strong>
                                            <a class="shelter-link" @onclick="() => NavigateToShelter(pet.ShelterName, pet.ShelterLocation)" @onclick:preventDefault="true">
                                                @pet.ShelterName <i class="fas fa-external-link-alt ms-1"></i>
                                            </a>
                                        </p>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning small">@Localizer["PetInformationUnavailable"]</div>
                                    }

                                    <hr />

                                    @if (!isUserRole && applicantUser != null)
                                    {
                                        <h6 class="mt-3"><i class="fa fa-user"></i> @Localizer["Applicant"]</h6>
                                        <p class="mb-1"><strong>@Localizer["Name"]:</strong> @applicantUser.PartitionKey</p>
                                        <p class="mb-1"><strong>@Localizer["Email"]:</strong> @applicantUser.RowKey</p>
                                        <p class="mb-1"><strong>@Localizer["Phone"]:</strong> @applicantUser.PhoneNumber</p>
                                        <hr />
                                    }

                                    <p class="mb-1">
                                        <strong>@Localizer["Status"]:</strong>
                                        <span class="badge bg-@GetStatusColor(application.AdoptionStatus) @(isAdopted ? "pulse-badge" : "")">
                                            @if (isAdopted)
                                            {
                                                <i class="fa fa-heart me-1"></i>
                                            }
                                            @GetStatusDisplay(application.AdoptionStatus, isUserRole)
                                        </span>
                                    </p>
                                    <p class="mb-1"><strong>@Localizer["Submitted"]:</strong> @application.DateSubmitted.ToShortDateString()</p>

                                    @if (isAdopted && isUserRole)
                                    {
                                        <div class="mt-3 p-2 bg-light rounded border border-success">
                                            <p class="small text-success mb-0">
                                                <i class="fa fa-check-circle"></i>
                                                <strong>@Localizer["WelcomeNewFamilyMember"]!</strong>
                                                @Localizer["ThankYouForeverHome", application.PetName]
                                            </p>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(application.Notes))
                                    {
                                        <hr />
                                        <p class="mb-1"><strong>@Localizer["Notes"]:</strong></p>
                                        <p class="small text-muted">@application.Notes</p>
                                    }
                                </div>
                                <div class="card-footer @(isAdopted ? "bg-success bg-opacity-10" : "bg-light")">
                                    <button class="btn btn-sm @(isAdopted ? "btn-success" : "btn-primary") w-100" @onclick="() => ViewApplicationDetails(application, pet, applicantUser)">
                                        <i class="fa @(isAdopted ? "fa-heart" : "fa-eye")"></i>
                                        @(isAdopted ? Localizer["ViewAdoption"] : Localizer["ViewDetails"])
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </section>
</div>

@* Application Details Modal *@
@if (showDetailsModal && selectedApplication != null)
{
    var isAdoptedModal = selectedApplication.AdoptionStatus == AdoptionStatus.Adopted;

    <ModalHelper OnClose="CloseDetailsModal" ModalId="application-details-modal" />
    <div id="application-details-modal" class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content @(isAdoptedModal ? "adopted-modal" : "")">
                <div class="modal-header bg-@GetStatusColor(selectedApplication.AdoptionStatus) text-white position-relative">
                    @if (isAdoptedModal)
                    {
                        <div class="confetti-container">
                            <span class="confetti">🎊</span>
                            <span class="confetti">🎉</span>
                            <span class="confetti">✨</span>
                            <span class="confetti">🌟</span>
                            <span class="confetti">💝</span>
                        </div>
                    }
                    <h5 class="modal-title">
                        <i class="fa @(isAdoptedModal ? "fa-heart" : "fa-paw")"></i>
                        @(isAdoptedModal ? Localizer["SuccessfulAdoption"] : Localizer["AdoptionApplicationDetails"]) - @selectedApplication.PetName
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseDetailsModal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @if (isProcessing)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">@Localizer["Processing"]</span>
                            </div>
                            <p class="mt-2">@Localizer["Processing"]</p>
                        </div>
                    }
                    else
                    {
                        @if (isAdoptedModal && isUserRole)
                        {
                            <div class="adoption-success-message text-center py-4 mb-4">
                                <i class="fa fa-trophy text-warning fa-4x mb-3 animated-bounce"></i>
                                <h3 class="text-success fw-bold mb-3">
                                    @Localizer["CongratulationsNewFamilyMember"]
                                </h3>
                                <p class="lead text-muted mb-3">
                                    @Localizer["GivenLovingHome", selectedApplication.PetName]
                                </p>
                                <div class="row justify-content-center mb-3">
                                    <div class="col-auto">
                                        <div class="p-3 bg-light rounded-circle">
                                            <i class="fa fa-heart text-danger fa-2x animated-heartbeat"></i>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-muted mb-0">
                                    @Localizer["BeginningBeautifulJourney", selectedApplication.PetName]
                                </p>
                                <hr class="my-4" />
                            </div>
                        }

                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fa fa-paw"></i> @Localizer["PetInformation"]
                                    @if (selectedPet != null && !string.IsNullOrEmpty(selectedPet.Image1Url))
                                    {
                                        <small class="text-muted ms-2">(@Localizer["ClickToEnlarge"])</small>
                                    }
                                </h6>
                                @if (selectedPet != null)
                                {
                                    <div class="position-relative">
                                        @if (!string.IsNullOrEmpty(selectedPet.Image1Url))
                                        {
                                            <img src="@selectedPet.Image1Url"
                                                 class="img-fluid rounded mb-3 modal-pet-image clickable-image @(isAdoptedModal ? "adopted-image-modal" : "")"
                                                 alt="@selectedPet.PartitionKey"
                                                 style="cursor: pointer;"
                                                 @onclick="() => ShowImageViewer(selectedPet.Image1Url)"
                                                 @onclick:stopPropagation="true"
                                                 onerror="this.src='/images/placeholder-pet.jpg';" />
                                            @if (isAdoptedModal)
                                            {
                                                <div class="adopted-badge-overlay" style="pointer-events: none;">
                                                    <span class="badge bg-success fs-5 px-4 py-2">
                                                        <i class="fa fa-heart me-2"></i>@Localizer["Adopted"].ToUpperInvariant()<i class="fa fa-heart ms-2"></i>
                                                    </span>
                                                </div>
                                            }
                                        }
                                    </div>
                                    <p><strong>@Localizer["Name"]:</strong> @selectedPet.PartitionKey</p>
                                    <p><strong>@Localizer["Species"]:</strong> @selectedPet.Species</p>
                                    <p><strong>@Localizer["Breed"]:</strong> @(selectedPet.Breed ?? Localizer["NotSpecified"])</p>
                                    <p><strong>@Localizer["Gender"]:</strong> @selectedPet.Gender</p>
                                    <p><strong>@Localizer["Size"]:</strong> @selectedPet.Size</p>
                                    <p><strong>@Localizer["Age"]:</strong> @GetPetAge(selectedPet.RowKey)</p>
                                    <p><strong>@Localizer["Colour"]:</strong> @(selectedPet.Colour ?? Localizer["NotSpecified"])</p>
                                    <p><strong>@Localizer["NeuteredSpayed"]:</strong> @(selectedPet.Neutered ? Localizer["Yes"] : Localizer["No"])</p>
                                    <p><strong>@Localizer["Dewormed"]:</strong> @(selectedPet.Dewormed ? Localizer["Yes"] : Localizer["No"])</p>
                                    <p><strong>@Localizer["Microchipped"]:</strong> @(selectedPet.Chipped ? Localizer["Yes"] : Localizer["No"])</p>
                                    <p><strong>@Localizer["Vaccinations"]:</strong> @selectedPet.Vaccinations</p>

                                    <h6 class="border-bottom pb-2 mb-2 mt-3">@Localizer["AboutPet"]</h6>
                                    <p class="small">@selectedPet.About</p>

                                    @if (!string.IsNullOrEmpty(selectedPet.MedicalTreatments))
                                    {
                                        <h6 class="border-bottom pb-2 mb-2 mt-3">@Localizer["MedicalTreatments"]</h6>
                                        <p class="small">@selectedPet.MedicalTreatments</p>
                                    }

                                    @if (!string.IsNullOrEmpty(selectedPet.KnownMedicalIssues))
                                    {
                                        <h6 class="border-bottom pb-2 mb-2 mt-3">@Localizer["KnownMedicalIssues"]</h6>
                                        <p class="small text-danger">@selectedPet.KnownMedicalIssues</p>
                                    }

                                    <h6 class="border-bottom pb-2 mb-2 mt-3">@Localizer["ShelterInfo"]</h6>
                                    <p>
                                        <strong>@Localizer["Name"]:</strong>
                                        <a class="shelter-link" @onclick="() => NavigateToShelter(selectedPet.ShelterName, selectedPet.ShelterLocation)" @onclick:preventDefault="true">
                                            @selectedPet.ShelterName <i class="fas fa-external-link-alt ms-1"></i>
                                        </a>
                                    </p>
                                    <p><strong>@Localizer["Location"]:</strong> @selectedPet.ShelterLocation</p>
                                }
                                else
                                {
                                    <div class="alert alert-warning">@Localizer["PetInformationUnavailable"]</div>
                                }
                            </div>

                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3"><i class="fa fa-file-text"></i> @Localizer["ApplicationInformation"]</h6>
                                <p>
                                    <strong>@Localizer["Status"]:</strong>
                                    <span class="badge bg-@GetStatusColor(selectedApplication.AdoptionStatus) @(isAdoptedModal ? "pulse-badge" : "")">
                                        @if (isAdoptedModal)
                                        {
                                            <i class="fa fa-heart me-1"></i>
                                        }
                                        @GetStatusDisplay(selectedApplication.AdoptionStatus, isUserRole)
                                    </span>
                                </p>
                                <p><strong>@Localizer["DateSubmitted"]:</strong> @selectedApplication.DateSubmitted.ToShortDateString()</p>

                                @if (!string.IsNullOrEmpty(selectedApplication.Notes))
                                {
                                    <h6 class="border-bottom pb-2 mb-2 mt-3">@Localizer["ApplicationNotes"]</h6>
                                    <p class="small">@selectedApplication.Notes</p>
                                }

                                @if (!isUserRole && selectedApplicant != null)
                                {
                                    <h6 class="border-bottom pb-2 mb-3 mt-4"><i class="fa fa-user"></i> @Localizer["ApplicantInformation"]</h6>
                                    <p><strong>@Localizer["Name"]:</strong> @selectedApplicant.PartitionKey</p>
                                    <p><strong>@Localizer["Email"]:</strong> @selectedApplicant.RowKey</p>
                                    <p><strong>@Localizer["Phone"]:</strong> @selectedApplicant.PhoneNumber</p>
                                    <p><strong>@Localizer["Address"]:</strong> @selectedApplicant.Address</p>
                                    <p><strong>@Localizer["Country"]:</strong> @selectedApplicant.Country</p>

                                    @if (!string.IsNullOrEmpty(selectedApplicant.Website))
                                    {
                                        <p><strong>@Localizer["Website"]:</strong> <a href="@selectedApplicant.Website" target="_blank">@selectedApplicant.Website</a></p>
                                    }
                                }

                                @* User view when application is submitted (under review) *@
                                @if (isUserRole && selectedApplication.AdoptionStatus == AdoptionStatus.Submitted)
                                {
                                    <div class="alert alert-primary mt-4 border-primary">
                                        <h6 class="text-primary"><i class="fa fa-hourglass-half"></i> @Localizer["ApplicationUnderReview"]</h6>
                                        <p class="mb-2">
                                            <strong>@Localizer["GreatNews"]!</strong> @Localizer["ApplicationSubmittedSuccess", selectedApplication.PetName]
                                            @if (selectedPet != null)
                                            {
                                                <a class="shelter-link" @onclick="() => NavigateToShelter(selectedPet.ShelterName, selectedPet.ShelterLocation)" @onclick:preventDefault="true">
                                                    <strong>@selectedPet.ShelterName</strong>
                                                </a>
                                            }
                                            else
                                            {
                                                <strong>the shelter</strong>
                                            }
                                            ! 🎉
                                        </p>
                                        <hr />
                                        <div class="bg-white p-3 rounded mb-2">
                                            <p class="small mb-2">
                                                <i class="fa fa-heart text-danger"></i>
                                                <strong>@Localizer["RootingForYou"]!</strong> @Localizer["WhatHappensNext"]
                                            </p>
                                            <p class="small mb-0">
                                                <i class="fa fa-clock text-primary"></i>
                                                <strong>@Localizer["WhatHappensNext"]</strong> @Localizer["NotifiedOnceDecision", selectedApplication.PetName]
                                            </p>
                                        </div>
                                        <div class="text-center mt-3 mb-2">
                                            <p class="small text-muted mb-0">
                                                <i class="fa fa-info-circle"></i>
                                                @Localizer["NotifiedOnceDecision", selectedApplication.PetName]
                                            </p>
                                        </div>
                                    </div>
                                }

                                @* User view when shelter has accepted *@
                                @if (isUserRole && selectedApplication.AdoptionStatus == AdoptionStatus.AcceptedByShelter)
                                {
                                    <div class="alert alert-success mt-4 border-success">
                                        <h6 class="text-success"><i class="fa fa-check-circle"></i> @Localizer["ApplicationAccepted"]</h6>
                                        <p class="mb-2">
                                            <strong>@Localizer["GreatNews"]!</strong> @Localizer["ShelterAcceptedApplication", selectedApplication.PetName]
                                        </p>
                                        <hr />
                                        <h6 class="mb-2"><i class="fa fa-map-marker"></i> @Localizer["NextStepsTitle"]</h6>
                                        <ol class="small mb-2 ps-3">
                                            <li>@Localizer["Step1"]</li>
                                            <li>@Localizer["Step2"]</li>
                                            <li>@Localizer["Step3", selectedApplication.PetName]</li>
                                            <li>@Localizer["Step4"]</li>
                                        </ol>
                                        @if (selectedPet != null)
                                        {
                                            <div class="bg-white p-3 rounded mt-3 border">
                                                <h6 class="mb-2"><i class="fa fa-home"></i> @Localizer["ShelterContactInformation"]</h6>
                                                <p class="mb-1 small">
                                                    <strong>@Localizer["Name"]:</strong>
                                                    <a class="shelter-link" @onclick="() => NavigateToShelter(selectedPet.ShelterName, selectedPet.ShelterLocation)" @onclick:preventDefault="true">
                                                        @selectedPet.ShelterName
                                                    </a>
                                                </p>
                                                <p class="mb-1 small"><strong>@Localizer["Location"]:</strong> @selectedPet.ShelterLocation</p>
                                                <p class="mb-0 small text-muted">
                                                    <i class="fa fa-info-circle"></i> @Localizer["PleaseContactShelter"]
                                                </p>
                                            </div>
                                        }
                                    </div>
                                }

                                @* Shelter view when user needs to pick up (AcceptedByShelter status) *@
                                @if (!isUserRole && selectedApplication.AdoptionStatus == AdoptionStatus.AcceptedByShelter)
                                {
                                    <div class="alert alert-info mt-4 border-info">
                                        <h6 class="text-info"><i class="fa fa-clock"></i> @Localizer["AwaitingUserPickup"]</h6>
                                        <p class="small mb-2">
                                            @Localizer["AcceptedApplicationNotification", selectedApplication.PetName]
                                        </p>
                                        <p class="small mb-0">
                                            <i class="fa fa-hand-pointer"></i> @Localizer["OncePickedUp"]
                                        </p>
                                    </div>
                                }

                                @if (isAdoptedModal)
                                {
                                    <div class="alert alert-success mt-4 border-success">
                                        <h6 class="text-success"><i class="fa fa-check-circle"></i> @Localizer["AdoptionComplete"]</h6>
                                        <p class="small mb-2">
                                            @Localizer["AdoptionSuccessfullyCompleted"]
                                            @if (isUserRole)
                                            {
                                                <span>@Localizer["WishHappyYears", selectedApplication.PetName]</span>
                                            }
                                            else
                                            {
                                                <span>@Localizer["ThankYouHelpingFind", selectedApplication.PetName]</span>
                                            }
                                        </p>
                                        <div class="text-center mt-3">
                                            <i class="fa fa-paw text-success mx-1"></i>
                                            <i class="fa fa-heart text-danger mx-1"></i>
                                            <i class="fa fa-paw text-success mx-1"></i>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer @(isAdoptedModal ? "bg-success bg-opacity-10" : "")">
                    @* Shelter buttons - shown when status is Submitted *@
                    @if (!isUserRole && selectedApplication.AdoptionStatus == AdoptionStatus.Submitted && !isProcessing)
                    {
                        <button type="button" class="btn btn-success" @onclick="ShelterAcceptApplication">
                            <i class="fa fa-check"></i> @Localizer["Accept"]
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="ShelterRejectApplication">
                            <i class="fa fa-times"></i> @Localizer["Reject"]
                        </button>
                    }

                    @* Shelter button - shown when status is AcceptedByShelter (User has been notified, waiting for physical pickup) *@
                    @if (!isUserRole && selectedApplication.AdoptionStatus == AdoptionStatus.AcceptedByShelter && !isProcessing)
                    {
                        <button type="button" class="btn btn-success btn-lg" @onclick="ConfirmPhysicalAdoption">
                            <i class="fa fa-heart"></i> @Localizer["PetAdopted", selectedApplication.PetName]
                        </button>
                    }

                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal" disabled="@isProcessing">
                        @Localizer["Close"]
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Image Viewer Overlay -->
@if (showImageViewer && !string.IsNullOrEmpty(viewerImageUrl))
{
    <div class="image-viewer-overlay" @onclick="CloseImageViewer">
        <div class="image-viewer-container">
            <button type="button" class="image-viewer-close" @onclick="CloseImageViewer" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
            <img src="@viewerImageUrl" alt="Pet Image" class="image-viewer-image" @onclick:stopPropagation="true" />
            <div class="image-viewer-hint">
                <i class="fas fa-info-circle me-2"></i>@Localizer["ClickOutsideToClose"]
            </div>
        </div>
    </div>
}

<style>
    .application-card {
        transition: transform 0.2s, box-shadow 0.3s;
    }

        .application-card:hover {
            transform: translateY(-5px);
        }

    .modal.show.d-block {
        display: block !important;
    }

    /* Clickable Image Styles */
    .clickable-image-card {
        transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }

        .clickable-image-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            opacity: 0.9;
        }

    .clickable-image {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .clickable-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

    /* Image Viewer Overlay */
    .image-viewer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-in-out;
        cursor: pointer;
    }

    .image-viewer-container {
        position: relative;
        max-width: 95vw;
        max-height: 95vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: default;
    }

    .image-viewer-image {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        animation: zoomIn 0.3s ease-in-out;
    }

    .image-viewer-close {
        position: absolute;
        top: -50px;
        right: 0;
        background-color: rgba(255, 255, 255, 0.2);
        border: 2px solid white;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, transform 0.2s;
    }

        .image-viewer-close:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

    .image-viewer-hint {
        position: absolute;
        bottom: -40px;
        color: white;
        font-size: 14px;
        opacity: 0.8;
        text-align: center;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes zoomIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Adopted Card Styles */
    .adopted-card {
        border: 3px solid #28a745;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        animation: gentle-glow 2s infinite alternate;
        position: relative;
        overflow: hidden;
    }

    @@keyframes gentle-glow {
        from {
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        to {
            box-shadow: 0 0 30px rgba(40, 167, 69, 0.5);
        }
    }

    .adoption-celebration-ribbon {
        position: absolute;
        top: 15px;
        right: -35px;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #dc3545;
        padding: 5px 40px;
        font-weight: bold;
        font-size: 12px;
        transform: rotate(45deg);
        z-index: 10;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        animation: ribbon-shimmer 2s infinite;
    }

    @@keyframes ribbon-shimmer {
        0%, 100% {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
        }

        50% {
            background: linear-gradient(135deg, #ffed4e, #ffd700);
        }
    }

    .adopted-body {
        background: linear-gradient(to bottom, #ffffff, #f8f9fa);
    }

    .congratulations-banner {
        background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
        border-radius: 10px;
        border: 2px solid #28a745;
        animation: pulse-border 2s infinite;
    }

    @@keyframes pulse-border {
        0%, 100% {
            border-color: #28a745;
        }

        50% {
            border-color: #20c997;
        }
    }

    .animated-bounce {
        animation: bounce 1s infinite;
    }

    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    .animated-heartbeat {
        animation: heartbeat 1.5s infinite;
    }

    @@keyframes heartbeat {
        0%, 100% {
            transform: scale(1);
        }

        10%, 30% {
            transform: scale(1.1);
        }

        20%, 40% {
            transform: scale(1);
        }
    }

    .animated-star {
        animation: star-twinkle 1.5s infinite;
    }

    @@keyframes star-twinkle {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }

    .pulse-badge {
        animation: pulse-badge 1.5s infinite;
    }

    @@keyframes pulse-badge {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.05);
            opacity: 0.9;
        }
    }

    .heart-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.8;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.8));
    }

    .adopted-image {
        border: 3px solid #28a745;
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
    }

    .adopted-image-modal {
        border: 4px solid #28a745;
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
    }

    .adopted-badge-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: badge-float 3s infinite ease-in-out;
    }

    @@keyframes badge-float {
        0%, 100% {
            transform: translate(-50%, -50%) translateY(0);
        }

        50% {
            transform: translate(-50%, -50%) translateY(-10px);
        }
    }

    .adoption-success-message {
        background: linear-gradient(135deg, #e8f5e9, #fff3cd, #e8f5e9);
        border-radius: 15px;
        border: 3px solid #28a745;
    }

    .adopted-modal {
        border: 3px solid #28a745;
    }

    .confetti-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
    }

    .confetti {
        position: absolute;
        font-size: 24px;
        animation: confetti-fall 5s infinite;
        opacity: 0.8;
    }

        .confetti:nth-child(1) {
            left: 10%;
            animation-delay: 0s;
        }

        .confetti:nth-child(2) {
            left: 30%;
            animation-delay: 1s;
        }

        .confetti:nth-child(3) {
            left: 50%;
            animation-delay: 2s;
        }

        .confetti:nth-child(4) {
            left: 70%;
            animation-delay: 3s;
        }

        .confetti:nth-child(5) {
            left: 90%;
            animation-delay: 4s;
        }

    @@keyframes confetti-fall {
        0% {
            top: -10%;
            transform: rotate(0deg);
        }

        100% {
            top: 110%;
            transform: rotate(720deg);
        }
    }
</style>

@code {
    private List<AdoptionApplication> applications = new();
    private Dictionary<AdoptionApplication, Pet?> applicationPets = new();
    private Dictionary<AdoptionApplication, User?> applicationUsers = new();
    private User? currentUser;
    private bool isLoading = true;
    private bool isUserRole = false;
    private string? errorMessage;
    private string? successMessage;
    private string pageTitle = "My Adoptions";

    // Modal state
    private bool showDetailsModal = false;
    private bool isProcessing = false;
    private AdoptionApplication? selectedApplication;
    private Pet? selectedPet;
    private User? selectedApplicant;

    // Image viewer state
    private bool showImageViewer = false;
    private string? viewerImageUrl;

    protected override async Task OnInitializedAsync()
    {
        await LoadApplicationsAsync();
        
        // Subscribe to culture change
        LocalizationService.OnCultureChanged += OnCultureChanged;
    }

    private void OnCultureChanged()
    {
        // Update page title based on role
        pageTitle = isUserRole ? Localizer["MyAdoptionApplications"] : Localizer["AdoptionApplicationsForMyPets"];
        StateHasChanged();
    }

    public void Dispose()
    {
        LocalizationService.OnCultureChanged -= OnCultureChanged;
    }

    private async Task LoadApplicationsAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            applications.Clear();
            applicationPets.Clear();
            applicationUsers.Clear();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var email = user.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;
                if (!string.IsNullOrEmpty(email))
                {
                    currentUser = await UserService.GetUserByEmailAsync(email);

                    if (currentUser != null)
                    {
                        isUserRole = currentUser.Role == UserRole.User || currentUser.Role == UserRole.Foster;

                        if (isUserRole)
                        {
                            pageTitle = Localizer["MyAdoptionApplications"];
                            applications = (await AdoptionProcessService.GetUserAdoptionApplicationsAsync(
                                currentUser.RowKey)).ToList();
                        }
                        else if (currentUser.Role == UserRole.Shelter &&
                                 !string.IsNullOrEmpty(currentUser.ShelterName) &&
                                 !string.IsNullOrEmpty(currentUser.ShelterLocation))
                        {
                            pageTitle = Localizer["AdoptionApplicationsForMyPets"];
                            applications = (await AdoptionProcessService.GetShelterAdoptionApplicationsAsync(
                                currentUser.ShelterName,
                                currentUser.ShelterLocation)).ToList();
                        }

                        // Load associated pets and users
                        foreach (var application in applications)
                        {
                            try
                            {
                                var pet = await AdoptionProcessService.GetPetForApplicationAsync(application);
                                applicationPets[application] = pet;

                                if (!isUserRole)
                                {
                                    var applicant = await AdoptionProcessService.GetUserForApplicationAsync(application);
                                    applicationUsers[application] = applicant;
                                }
                            }
                            catch (Exception ex)
                            {
                                Logger.LogWarning(ex, "Error loading pet/user for application: {Message}", ex.Message);
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading adoption applications");
            errorMessage = $"Failed to load applications: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ViewApplicationDetails(AdoptionApplication application, Pet? pet, User? applicant)
    {
        selectedApplication = application;
        selectedPet = pet;
        selectedApplicant = applicant;
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedApplication = null;
        selectedPet = null;
        selectedApplicant = null;
        isProcessing = false;
    }

    private void NavigateToShelter(string shelterName, string shelterLocation)
    {
        var encodedName = Uri.EscapeDataString(shelterName);
        var encodedLocation = Uri.EscapeDataString(shelterLocation);
        Navigation.NavigateTo($"/shelters?name={encodedName}&location={encodedLocation}");
    }

    private async Task ShelterAcceptApplication()
    {
        if (selectedApplication == null) return;

        try
        {
            isProcessing = true;
            StateHasChanged();

            var result = await AdoptionProcessService.AcceptApplicationAsync(selectedApplication);

            if (result.Success)
            {
                successMessage = result.Message;

                // Refresh the modal data instead of closing
                await RefreshModalData();
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error accepting application");
            errorMessage = $"Failed to accept application: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ShelterRejectApplication()
    {
        if (selectedApplication == null) return;

        try
        {
            isProcessing = true;
            StateHasChanged();

            var result = await AdoptionProcessService.RejectApplicationAsync(selectedApplication);

            if (result.Success)
            {
                successMessage = result.Message;
                CloseDetailsModal();
                await LoadApplicationsAsync();
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error rejecting application");
            errorMessage = $"Failed to reject application: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmPhysicalAdoption()
    {
        if (selectedApplication == null) return;

        try
        {
            isProcessing = true;
            StateHasChanged();

            var result = await AdoptionProcessService.ConfirmAdoptionCompleteAsync(selectedApplication);

            if (result.Success)
            {
                successMessage = $"🎉 {Localizer["Congratulations"]}! {selectedApplication.PetName} has been successfully adopted!";

                // Refresh the modal data instead of closing
                await RefreshModalData();
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error confirming physical adoption");
            errorMessage = $"Failed to confirm adoption: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task RefreshModalData()
    {
        if (selectedApplication == null) return;

        try
        {
            // Reload the application list
            await LoadApplicationsAsync();

            // Find the updated application in the refreshed list using the new key structure
            var updatedApplication = applications.FirstOrDefault(a =>
                a.PartitionKey == selectedApplication.PartitionKey &&
                a.RowKey == selectedApplication.RowKey);

            if (updatedApplication != null)
            {
                // Update the selected application with the latest data
                selectedApplication = updatedApplication;

                // Update the selected pet if it exists in the dictionary
                if (applicationPets.ContainsKey(updatedApplication))
                {
                    selectedPet = applicationPets[updatedApplication];
                }

                // Update the selected applicant if it exists in the dictionary
                if (!isUserRole && applicationUsers.ContainsKey(updatedApplication))
                {
                    selectedApplicant = applicationUsers[updatedApplication];
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing modal data");
            errorMessage = $"Failed to refresh data: {ex.Message}";
        }
    }

    private string GetPetAge(string birthDateString)
    {
        if (!DateTime.TryParse(birthDateString, out var birthDate))
            return "Unknown";

        var age = DateTime.Now - birthDate;
        var years = (int)(age.TotalDays / 365.25);
        var months = (int)((age.TotalDays % 365.25) / 30.44);

        if (years > 0)
        {
            return months > 0 ? $"{years}y {months}m" : $"{years}y";
        }
        else if (months > 0)
        {
            return $"{months}m";
        }
        else
        {
            return $"{(int)age.TotalDays}d";
        }
    }

    private string GetStatusColor(AdoptionStatus status)
    {
        return status switch
        {
            AdoptionStatus.NotAdopted => "secondary",
            AdoptionStatus.Submitted => "primary",
            AdoptionStatus.AcceptedByShelter => "info",
            AdoptionStatus.Adopted => "success",
            _ => "secondary"
        };
    }

    private string GetStatusDisplay(AdoptionStatus status, bool isUserRole)
    {
        return status switch
        {
            AdoptionStatus.NotAdopted => Localizer["NotAdopted"],
            AdoptionStatus.Submitted => Localizer["PendingReview"],
            AdoptionStatus.AcceptedByShelter => Localizer["AcceptedByShelter"],
            AdoptionStatus.Adopted => Localizer["AdoptedStatus"],
            _ => status.ToString()
        };
    }

    // Image viewer methods
    private void ShowImageViewer(string imageUrl)
    {
        viewerImageUrl = imageUrl;
        showImageViewer = true;
        StateHasChanged();
    }

    private void CloseImageViewer()
    {
        showImageViewer = false;
        viewerImageUrl = null;
        StateHasChanged();
    }
}